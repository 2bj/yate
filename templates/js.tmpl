main

    function stylesheet(data) {

        %Runtime

        var c0 = makeRoot(data);

        %Stylesheet

        return applyValue([ c0 ], '');
    }

# ------------------------------------------------------------------------------------------------------------------- #

stylesheet

    %Predicates

    %Jpaths

    %Templates

    var matcher = %Matcher;

    %Defs

# ------------------------------------------------------------------------------------------------------------------- #

template

    // match %Jpath.Key : %Mode
    var t%Tid = {
        jpath: j%Jpath.Jid,
        body: %Body:function
    };

templateMode
    '%Value'

# ------------------------------------------------------------------------------------------------------------------- #

function_

    // %Name()
    var f%Fid = %Body:function

# ------------------------------------------------------------------------------------------------------------------- #

block

    %Defs
    %Exprs

block:function [ %Body.Context == 'list' ]

    function(c%Cid, r%Rid, index, count %Args) {
        %.:function-body
    }

block:function

    function(c%Cid, index, count %Args) {
        %.:function-body

        return r%Rid;
    }

block:function-body

    %Args.defaults()
    %.:prologue

    %.

block:prologue [ %Context != 'list' && %Type == 'array' ]

    var r%Rid = [];

block:prologue [ %Context != 'list' && %Type == 'object' ]

    var r%Rid = {};

block:prologue [ %Context != 'list' ]

    var r%Rid = '', a%Rid = {};


# ------------------------------------------------------------------------------------------------------------------- #

scalar [ %Context == 'list' && %Inline ]

    r%{Rid}.push( %Expr );

scalar [ %Inline ]

    r%Rid += %Expr;

scalar [ %Context == 'list' ]

    %Expr:prologue
    %Expr
    r%{Rid}.push( r%Expr.Rid );

scalar

    %Expr:prologue
    %Expr
    r%Rid += r%Expr.Rid;

pair [ %Value.Inline ]

    r%Rid[ %Key ] = %Value;

pair

    %Value:prologue
    %Value
    r%Rid[ %Key ] = r%Value.Rid;

# ------------------------------------------------------------------------------------------------------------------- #

key

    var k%{Kid}_nodes;
    var k%{Kid}_values = {};
    var k%{Kid}_get = function(key) {
        var value = k%{Kid}_values[key];
        if (!value) {
            var c%Cid = k%{Kid}_nodes[key];
            if (c%Cid) {
                %Body
            }
            if (value) {
                k%{Kid}_values[key] = value;
            }
        }
        return value || [];
    };
    var k%{Kid} = function(key) {
        if (!k%{Kid}_nodes) {
            var nodes = %Nodes;
            k%{Kid}_nodes = {};
            for (var i = 0, l = nodes.length; i < l; i++) {
                var c%Use.Cid = nodes[i];
                var useNodes = %Use;
                for (var j = 0, m = useNodes.length; j < m; j++) {
                    k%{Kid}_nodes[ nodeValue(useNodes[j]) ] = c%Use.Cid;
                }
            }

            k%{Kid} = k%{Kid}_get;
        }

        return k%{Kid}_get(key);
    };

# ------------------------------------------------------------------------------------------------------------------- #

var_ [ %Inline ]

    var v%Vid = %Value;

var_

    %Value
    var v%Vid = %Value.Rid;

# ------------------------------------------------------------------------------------------------------------------- #

if_ [ %Else ]

    if (%Condition) {
        %Then
    } else {
        %Else
    }

if_

    if (%Condition) {
        %Then
    }

# ------------------------------------------------------------------------------------------------------------------- #

for_

    var items%Cid = %Expr;
    for (var i%Cid = 0, l%Cid = items%{Cid}.length; i%Cid < l%Cid; i%Cid++) {
        var c%Body.Cid = items%Cid[ i%Cid ];
        %Body
    }

# ------------------------------------------------------------------------------------------------------------------- #

apply [ %Context == 'list' ]

    applyList(%Expr, %Mode, r%Rid %Args);

apply

    r%Rid += applyValue(%Expr, %Mode, a%Rid %Args);

# ------------------------------------------------------------------------------------------------------------------- #

attr [ %Inline ]

    a%Rid['%Name'] %Op %Expr;

attr

    %Expr
    a%Rid['%Name'] %Op r%Expr.Rid;

# ------------------------------------------------------------------------------------------------------------------- #

inlineOr
    %Left || %Right

inlineAnd
    %Left && %Right

inlineNot
    !%Left

inlineEq
    %Left %Op %Right

inlineRel
    %Left %Op %Right

inlineAdd
    %Left %Op %Right

inlineMul
    %Left %Op %Right

inlineUnary
    -%Expr

inlineUnion
    join(%Left, %Right)

inlineComplex
    (%Expr)

inlineFunction [ %Fid && %Args ]
    f%Fid(c%Cid, index, count, %Args)

inlineFunction [ %Args ]
    %Name(c%Cid, index, count, %Args)

inlineFunction [ %Fid ]
    f%Fid(c%Cid, index, count)

inlineFunction
    %Name(c%Cid, index, count)

inlineVar
    v%Vid

inlineNumber
    %Value

string
    %String

jpath [ %Context ]
    selectContext(j%Jid, %Context)

jpath
    select(j%Jid, c%Cid)

predicate

    // %Key
    var p%Pid = function(c%Cid, index, count) {
        return %Expr;
    };

jpaths_item ( %Predicates = '[]', %Absolute = '0' )

    // %Jid. %Key
    var j%Jid = {
        steps: %Steps,
        preds: %Predicates,
        abs: %Absolute
    };

argListItem
    , v%Vid

argListItemDefault
    v%Vid = v%Vid || %Default;

inlineString
    %Value

cast [ %From == 'nodeset' && (%To == 'scalar' || %To == 'xml') ]
    nodeset2scalar(%Expr)

cast [ %From == 'nodeset' && %To == 'boolean' ]
    nodeset2boolean(%Expr)

cast
    %Expr

stringExpr
    %Expr

stringLiteral
    '%Value'

function_true
    true

function_false
    false

function_name
    c%{Cid}.name

function_position
    index

function_count
    count

function_slice
    slice(%Args)

closeAttrs

    if (r%{Rid}.open) { closeAttrs(r%Rid); }

quote
    %{Mode}Quote(%Expr)

usekey
    k%Kid(%Args)

inlineGrep
    grep(%Expr, p%Predicate.Pid)

inlineIndex
    byIndex(%Expr, %Index)


